<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Web OS - Desktop</title>
        <link rel="icon" href="/media/favicon.png" type="image/png">
        <link rel="stylesheet" href="/pages/desktop/index.css" />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    </head>
    <script type="module" src="/custom-elements/define.mjs"></script>
    <script type="module">
        import { FileStorage } from "/utils/fileStorage.js";
        import { createPictureShortcut } from "/utils/createFromFileStorage.js";
        import Taskbar from "/custom-elements/taskbar/taskbar.mjs";
        import Settings, {
            THEMES_FILTERS,
        } from "/custom-elements/settings.mjs";

        const theme =
            JSON.parse(String(localStorage.getItem("theme"))) ||
            THEMES_FILTERS.purple;

        const root = document.querySelector(":root");
        root.style.setProperty("--theme-filter", theme.filter);
        root.style.setProperty("--window-bg", theme.windowBg);

        const scale = localStorage.getItem("scale") || "13px";
        root.style.setProperty("--scale", scale);

        FileStorage.init();

        // init shortcuts
        for (const [id, info] of FileStorage.getPictures()) {
            createPictureShortcut(info);
        }

        function openSettings(event) {
            Taskbar.instance.container.dataset.settingsOpen = true;
            Taskbar.instance.tasksWrapper.style.opacity = 0;
            Taskbar.instance.tasksWrapper.style.pointerEvents = "none";
            Settings.instance.updateDefaultUserInfo();

            setTimeout(() => {
                Taskbar.instance.settings.classList.add(
                    "settings-load-animation"
                );
                Taskbar.instance.settingsButtons.classList.add(
                    "settings-load-animation"
                );
            }, 500);
        }

        document
            .querySelector("#os-logo")
            .addEventListener("click", openSettings);
    </script>
    <script src="https://unpkg.com/@ungap/custom-elements-builtin"></script>
    <script type="module" src="https://unpkg.com/x-frame-bypass"></script>

    <body oncontextmenu="return false;">
        <div id="transition-layer">
            <img
                class="center-logo"
                src="/media/logo-basic.svg"
                alt="os-logo"
                draggable="false"
            />
        </div>
        <main>
            <!-- <settings-menu></settings-menu> -->
            <img
                id="os-logo"
                class="center-logo"
                src="/media/os-logo.png"
                alt="os-logo"
                draggable="false"
            />
            <div id="preview-bg"></div>
            <section id="shortcuts">
                <desktop-shortcut
                    wc-tag-name="js-coder"
                    name="JSCoder"
                    icon-src="/media/editor-icon.svg"
                ></desktop-shortcut>
                <desktop-shortcut
                    wc-tag-name="web-browser"
                    name="Browser"
                    icon-src="/media/browser-icon.png"
                ></desktop-shortcut>
                <desktop-shortcut
                    wc-tag-name="web-calculator"
                    name="Calcs"
                    icon-src="/media/calcs-icon.png"
                ></desktop-shortcut>
                <desktop-shortcut
                    wc-tag-name="web-recorder"
                    name="Recorder"
                    icon-src="/media/recorder-icon.png"
                ></desktop-shortcut>
                <desktop-shortcut
                    wc-tag-name="web-imh"
                    name="I.M.H"
                    icon-src="/media/imh-icon.png"
                ></desktop-shortcut>
            </section>
            <section id="windows"></section>

            <!-- <ul
                id="context-menu"
                tabindex="0"
                onblur="(event) => console.log(event)"
            >
                <li><button>Edit mode</button></li>
            </ul> -->

            <desktop-clock></desktop-clock>
        </main>
        <desktop-taskbar></desktop-taskbar>
    </body>

    <script>
        window.audio = new Audio();

        const audioDisabled = localStorage.getItem("disable-audio");

        if (!localStorage.getItem("logged")) {
            window.location.replace("../login.html");
        }

        const transitionLayer = document.querySelector("#transition-layer");
        const transitionLogo = transitionLayer.querySelector("img");

        const transitionWidth = localStorage.getItem("logo-width-from-login");
        if (transitionWidth) {
            localStorage.removeItem("logo-width-from-login");
            transitionLogo.style.width = transitionWidth;
            document.querySelector("#os-logo").style.width = transitionWidth;
        }

        function hideTransitionLayer() {
            transitionLayer.style.opacity = 0;
            transitionLayer.style.pointerEvents = "none";
            transitionLayer.style.userSelect = "none";
            transitionLayer.className = "";
        }

        if (localStorage.getItem("from-boot")) {
            setTimeout(async () => {
                localStorage.removeItem("from-boot");
                hideTransitionLayer();

                if (!audioDisabled) {
                    window.audio.src = "/media/audio/logged-in.mp3";
                    await window.audio.play();
                }
            }, 200);
        } else {
            hideTransitionLayer();
        }

        window.oncontextmenu(e => false);

        window.L = L;
    </script>
</html>
